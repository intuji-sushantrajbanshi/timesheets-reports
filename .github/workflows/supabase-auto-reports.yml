name: Export Supabase Data to CSV

on:
  schedule:
    - cron: '15 11 * * *' # Every day at 5 PM Nepal/Kathmandu Time (UTC+5:45)
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - master
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  export-data:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas python-dateutil pytz

      - name: Check Supabase credentials
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_KEY" ]; then
            echo "‚ùå Supabase credentials are not properly set in GitHub secrets."
            exit 1
          else
            echo "‚úÖ Supabase credentials found"
          fi

      - name: Export data from Supabase
        run: |
          mkdir -p exports
          python -c '
          import os
          import requests
          import pandas as pd
          import json
          from datetime import datetime, timedelta
          import pytz
          
          # Configuration
          supabase_url = os.environ["SUPABASE_URL"]
          supabase_key = os.environ["SUPABASE_KEY"]
          
          # Common headers for all requests
          headers = {
              "apikey": supabase_key,
              "Authorization": f"Bearer {supabase_key}",
              "Content-Type": "application/json",
              "Prefer": "return=representation"
          }
          
          def fetch_data(table_name, query_params=None, select_fields="*"):
              """Fetch data from Supabase table and return as DataFrame"""
              endpoint = f"{supabase_url}/rest/v1/{table_name}"
              
              params = {}
              if select_fields != "*":
                  params["select"] = select_fields
                  
              if query_params:
                  params.update(query_params)
                  
              try:
                  response = requests.get(endpoint, headers=headers, params=params)
                  response.raise_for_status()
                  
                  data = response.json()
                  if not data:
                      print(f"No data returned for {table_name}")
                      return pd.DataFrame()
                      
                  df = pd.DataFrame(data)
                  print(f"‚úÖ Successfully fetched {len(df)} rows from {table_name}")
                  return df
                  
              except Exception as e:
                  print(f"‚ùå Error fetching {table_name}: {str(e)}")
                  return pd.DataFrame()
          
          # Calculate date for filtering time entries (last 30 days)
          thirty_days_ago = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
          current_date = datetime.now().strftime("%Y-%m-%d")
          
          # Export active companies
          companies = fetch_data("Company", {"deletedAt": "is.null"})
          if not companies.empty:
              companies.to_csv("exports/companies.csv", index=False)
              
          # Export active projects
          projects = fetch_data("Project", {"deletedAt": "is.null"})
          if not projects.empty:
              projects.to_csv("exports/projects.csv", index=False)
              
          # Export active users
          users = fetch_data("User", {"deletedAt": "is.null"})
          if not users.empty:
              # Remove sensitive fields
              if "password" in users.columns:
                  users = users.drop(columns=["password"])
              users.to_csv("exports/users.csv", index=False)
              
          # Export activity types
          activity_types = fetch_data("ActivityType", {"deletedAt": "is.null"})
          if not activity_types.empty:
              activity_types.to_csv("exports/activity_types.csv", index=False)
              
          # Export focus areas
          focus_areas = fetch_data("FocusArea", {"deletedAt": "is.null"})
          if not focus_areas.empty:
              focus_areas.to_csv("exports/focus_areas.csv", index=False)
              
          # Export time entries from last 30 days
          time_entries = fetch_data("TimeEntry", 
                                   {"deletedAt": "is.null", 
                                    "entryDate": f"gte.{thirty_days_ago}"})
          if not time_entries.empty:
              time_entries.to_csv("exports/time_entries.csv", index=False)
              
          # Export submissions
          submissions = fetch_data("Submission", {"deletedAt": "is.null"})
          if not submissions.empty:
              submissions.to_csv("exports/submissions.csv", index=False)
              
          # Create a summary file with export information
          with open("exports/export_summary.json", "w") as f:
              summary = {
                  "export_date": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                  "tables_exported": {
                      "companies": len(companies) if not companies.empty else 0,
                      "projects": len(projects) if not projects.empty else 0,
                      "users": len(users) if not users.empty else 0,
                      "activity_types": len(activity_types) if not activity_types.empty else 0,
                      "focus_areas": len(focus_areas) if not focus_areas.empty else 0,
                      "time_entries": len(time_entries) if not time_entries.empty else 0,
                      "submissions": len(submissions) if not submissions.empty else 0
                  },
                  "time_entries_period": f"{thirty_days_ago} to {current_date}"
              }
              json.dump(summary, f, indent=2)
          
          # Get current timestamp for HTML
          timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
          
          # Create an index.html file for GitHub Pages
          html_content = f"""<!DOCTYPE html>
          <html>
          <head>
              <title>Supabase Data Exports</title>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <style>
                  body {{ font-family: Arial, sans-serif; margin: 0; padding: 20px; line-height: 1.6; }}
                  h1 {{ color: #333; }}
                  .container {{ max-width: 800px; margin: 0 auto; }}
                  table {{ width: 100%; border-collapse: collapse; margin: 20px 0; }}
                  th, td {{ padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }}
                  th {{ background-color: #f2f2f2; }}
                  .download-btn {{ display: inline-block; background-color: #4CAF50; color: white; 
                                  padding: 8px 16px; text-decoration: none; border-radius: 4px; }}
                  .download-btn:hover {{ background-color: #45a049; }}
                  .timestamp {{ color: #666; font-style: italic; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Supabase Data Exports</h1>
                  <p class="timestamp">Last updated: {timestamp} UTC</p>
                  
                  <table>
                      <tr>
                          <th>Dataset</th>
                          <th>Records</th>
                          <th>Download</th>
                      </tr>
                      <tr>
                          <td>Companies</td>
                          <td>{len(companies) if not companies.empty else 0}</td>
                          <td><a href="companies.csv" class="download-btn">Download CSV</a></td>
                      </tr>
                      <tr>
                          <td>Projects</td>
                          <td>{len(projects) if not projects.empty else 0}</td>
                          <td><a href="projects.csv" class="download-btn">Download CSV</a></td>
                      </tr>
                      <tr>
                          <td>Users</td>
                          <td>{len(users) if not users.empty else 0}</td>
                          <td><a href="users.csv" class="download-btn">Download CSV</a></td>
                      </tr>
                      <tr>
                          <td>Activity Types</td>
                          <td>{len(activity_types) if not activity_types.empty else 0}</td>
                          <td><a href="activity_types.csv" class="download-btn">Download CSV</a></td>
                      </tr>
                      <tr>
                          <td>Focus Areas</td>
                          <td>{len(focus_areas) if not focus_areas.empty else 0}</td>
                          <td><a href="focus_areas.csv" class="download-btn">Download CSV</a></td>
                      </tr>
                      <tr>
                          <td>Time Entries (Last 30 Days)</td>
                          <td>{len(time_entries) if not time_entries.empty else 0}</td>
                          <td><a href="time_entries.csv" class="download-btn">Download CSV</a></td>
                      </tr>
                      <tr>
                          <td>Submissions</td>
                          <td>{len(submissions) if not submissions.empty else 0}</td>
                          <td><a href="submissions.csv" class="download-btn">Download CSV</a></td>
                      </tr>
                  </table>
                  
                  <h2>Export Summary</h2>
                  <p>Time period for time entries: {thirty_days_ago} to {current_date}</p>
                  <p><a href="export_summary.json">View detailed export summary (JSON)</a></p>
              </div>
          </body>
          </html>"""
          
          with open("exports/index.html", "w") as f:
              f.write(html_content)
          
          print("‚úÖ Data export completed successfully")
          '

      - name: Upload CSV artifacts
        uses: actions/upload-artifact@v4
        with:
          name: supabase-data-exports-${{ github.run_number }}
          path: exports/
          retention-days: 30

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: exports
          publish_branch: gh-pages
          keep_files: false
          commit_message: "üìä Update Supabase data exports - ${{ github.run_number }}"
